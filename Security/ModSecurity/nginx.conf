limit_req_zone $binary_remote_addr zone=frontend_limit:10m rate=30r/s;

limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;

limit_req_zone $binary_remote_addr zone=auth_strict:10m rate=1r/s;

server {
    listen 80;
    server_name olaaroub.dev localhost;
    absolute_redirect off;
    return 301 https://$host:443$request_uri;
}

server {
    listen 8080;
    server_name olaaroub.dev localhost;
    absolute_redirect off;
    return 301 https://$host:443$request_uri;
}

server {
    listen 443 ssl;
    server_name olaaroub.dev localhost;
    modsecurity on;
    absolute_redirect off;

    ssl_certificate     /etc/nginx/certs/nginx.crt;
    ssl_certificate_key /etc/nginx/certs/nginx.key;
    ssl_protocols       TLSv1.2 TLSv1.3;
    ssl_ciphers         HIGH:!aNULL:!MD5;

    limit_req_status 429;

    # ====================================================
    #              ADMIN / INFRASTRUCTURE
    # ====================================================
    location /grafana/ {
        limit_req zone=api_limit burst=100 nodelay;
        modsecurity off;

        proxy_pass http://grafana-prod:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
    }

    location /health {
        access_log off;
        modsecurity off;
        return 200 "healthy";
    }

    # ====================================================
    #            Brute Force Protection
    # ====================================================
    location /api/auth/ {
        limit_req zone=auth_strict burst=5 nodelay;

        proxy_pass http://auth-service-prod:3001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ====================================================
    # G               ENERAL API ENDPOINTS
    # ====================================================

    location /api/user/ {
        limit_req zone=api_limit burst=20 nodelay;
        proxy_pass http://user-service-prod:3002;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    location /api/public/ {
        limit_req zone=api_limit burst=20 nodelay;
        proxy_pass http://user-service-prod:3002;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /api/chat/global/ {
        limit_req zone=api_limit burst=20 nodelay;
        proxy_pass http://global-chat-prod:3003;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
    }

     location /api/chat/private/ {
        limit_req zone=api_limit burst=20 nodelay;
        proxy_pass http://private-chat-prod:3004;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
    }

    location /api/game/ {
        limit_req zone=api_limit burst=50 nodelay;
        proxy_pass http://pong-game-prod:3005;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 86400s;
        proxy_send_timeout 86400s;
    }

    # ====================================================
    #           FRONTEND / STATIC CONTENT
    # ====================================================

    location /game/ {
        limit_req zone=frontend_limit burst=100 nodelay;

        proxy_pass http://frontend-prod:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
    }

    location / {
        limit_req zone=frontend_limit burst=100 nodelay;

        proxy_pass http://frontend-prod:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}