input {
  beats {
    port => 50000
  }
}

filter {
  # 1. PARSE JSON (The Safe Way)
  if [message] =~ /^\{/ {
    json {
      source => "message"
      # REMOVING 'target' is the magic fix.
      # It automatically moves all JSON fields to the root, so you don't need Ruby.
      skip_on_invalid_json => true
    }
  }

  # 2. STANDARDIZATION
  # Since we removed 'target => payload', fields are now at the root.
  # We check [service_name] instead of [payload][service_name]
  if [service_name] {
    mutate { add_field => { "[service][name]" => "%{service_name}" } }
  }
  # Filebeat standard: check [container][name]
  else if [container][name] {
    mutate { add_field => { "[service][name]" => "%{[container][name]}" } }
  }
  else {
    mutate { add_field => { "[service][name]" => "unknown-service" } }
  }

  # 3. TIMESTAMP HANDLING (Crucial for production)
  # If your JSON has a "time" or "timestamp" field, we must use the date filter
  # to update @timestamp safely, instead of crashing.
  if [time] {
    date {
      match => [ "time", "ISO8601" ]
      target => "@timestamp"
      remove_field => ["time"]
    }
  }

  mutate {
    lowercase => [ "[service][name]" ]

    remove_field => ["message", "input", "ecs", "agent", "host"]
  }

}

output {
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    index => "logs-%{[service][name]}-default"
    action => "create"
  }
}