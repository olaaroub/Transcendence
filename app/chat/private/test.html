<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Private Chat - Socket.io Test</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background-color: #f4f4f9; }
        .container { max-width: 500px; margin: auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        #messages { border: 1px solid #ddd; height: 300px; overflow-y: auto; margin: 15px 0; padding: 10px; border-radius: 5px; background: #fafafa; }
        .msg-item { margin-bottom: 10px; padding: 8px; border-radius: 5px; }
        .received { background: #e1ffc7; text-align: left; }
        .sent { background: #cfe9ff; text-align: right; }
        input { width: calc(100% - 22px); padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 5px; }
        button { width: 100%; padding: 10px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        button:hover { background: #218838; }
        .status { font-size: 0.8em; color: gray; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ’¬ Private Chat Test</h2>
    
    <div id="connection-panel">
        <input type="number" id="myId" placeholder="Enter My User ID (e.g., 1)">
        <button type="button" onclick="connectToServer()">Step 1: Connect & Go Online</button>
    </div>

    <div id="chat-panel" style="display:none;">
        <div id="status-bar" class="status">Offline</div>
        <div id="messages"></div>
        <input type="number" id="toId" placeholder="Receiver User ID">
        <input type="text" id="msg" placeholder="Write a message...">
        <button type="button" onclick="sendMessage(event)">Step 2: Send Message</button>
    </div>
</div>

<script>
    let socket;

    function connectToServer() {
        const userId = document.getElementById('myId').value;
        if (!userId) return alert("Please enter your User ID first!");

        // Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±
        socket = io("http://localhost:8405");

        socket.on("connect", () => {
            console.log("Connected to Socket.io Server");
            
            // Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„ØºØ±ÙØ© Ø®Ø§ØµØ©
            socket.emit("join_private", userId);

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            document.getElementById('connection-panel').style.display = 'none';
            document.getElementById('chat-panel').style.display = 'block';
            document.getElementById('status-bar').innerText = `Logged in as User: ${userId} (Online)`;
        });

        // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ù† Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±
        socket.on("receive_message", (data) => {
            console.log("New Message:", data);
            appendMessage(data.senderId, data.content, 'received');
        });

        socket.on("disconnect", () => {
            document.getElementById('status-bar').innerText = "Disconnected from Server";
            document.getElementById('status-bar').style.color = "red";
        });
    }

    function sendMessage(event) {
        // Ù…Ù†Ø¹ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø© ØªÙ…Ø§Ù…Ø§Ù‹ Ù…Ù‡Ù…Ø§ ÙƒØ§Ù† Ù†ÙˆØ¹ Ø§Ù„Ø²Ø±
        if (event) event.preventDefault();

        const myId = document.getElementById('myId').value;
        const receiverId = document.getElementById('toId').value;
        const content = document.getElementById('msg').value;

        if (!receiverId || !content) return alert("Please fill Receiver ID and Message");

        const payload = {
            conversationId: 1, // ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø±Ù‚Ù… 1 Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ù€ DB
            senderId: myId,
            receiverId: receiverId,
            content: content
        };

        // Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± Ø§Ù„Ø³ÙˆÙƒÙŠØª
        socket.emit("send_message", payload);

        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙÙŠ Ø´Ø§Ø´ØªÙŠ
        appendMessage('Me', content, 'sent');
        
        // Ù…Ø³Ø­ Ø®Ø§Ù†Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
        document.getElementById('msg').value = '';
    }

    function appendMessage(sender, text, type) {
        const msgDiv = document.getElementById('messages');
        const newMsg = document.createElement('div');
        newMsg.className = `msg-item ${type}`;
        newMsg.innerHTML = `<strong>${sender}:</strong> ${text}`;
        msgDiv.appendChild(newMsg);
        
        // Ø§Ù„Ù†Ø²ÙˆÙ„ Ù„Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
        msgDiv.scrollTop = msgDiv.scrollHeight;
    }
</script>

</body>
</html>