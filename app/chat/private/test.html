<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Socket.IO Chat Test</title>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background: #0f172a;
  color: #e5e7eb;
}
input, button {
  padding: 6px;
  margin: 4px;
}
button {
  cursor: pointer;
}
#log, #chat {
  background: #020617;
  border: 1px solid #334155;
  padding: 10px;
  height: 200px;
  overflow-y: auto;
  margin-top: 10px;
}
.section {
  border: 1px solid #334155;
  padding: 10px;
  margin-top: 10px;
}
</style>
</head>

<body>

<h2>Socket.IO Chat + Notifications Test</h2>

<div class="section">
  <h3>Connection</h3>
  <input id="userId" placeholder="Your userId (ex: 1)" />
  <button onclick="connect()">Connect</button>
  <button onclick="joinPrivate()">Join Private</button>
</div>

<div class="section">
  <h3>Open Chat</h3>
  <input id="receiverId" placeholder="Receiver userId (ex: 2)" />
  <button onclick="openChat()">Open Chat</button>
</div>

<div class="section">
  <h3>Send Message</h3>
  <input id="message" placeholder="Message..." />
  <button onclick="sendMessage()">Send</button>
</div>

<div class="section">
  <h3>Chat Messages</h3>
  <div id="chat"></div>
</div>

<div class="section">
  <h3>Logs / Notifications</h3>
  <div id="log"></div>
</div>

<script>
  let socket;
  let conversationId = null;
  
  function log(msg) {
    const el = document.getElementById("log");
    el.innerHTML += `<div>${msg}</div>`;
    el.scrollTop = el.scrollHeight;
  }
  
  function chat(msg) {
    const el = document.getElementById("chat");
    el.innerHTML += `<div>${msg}</div>`;
    el.scrollTop = el.scrollHeight;
  }
  
  function clearChat() {
    document.getElementById("chat").innerHTML = "";
  }
  
  function connect() {
    socket = io("http://localhost:8405");
  
    socket.on("connect", () => {
      log(`âœ… Connected (socket.id = ${socket.id})`);
    });
  
    socket.on("chat_initialized", (data) => {
      conversationId = data.conversationId;
      clearChat();
      chat(`ðŸŸ¢ Chat opened (ID: ${conversationId})`);
      
      data.messages.forEach(m => {
        chat(`[${m.senderId}] ${m.content}`);
      });
    });
  
    socket.on("receive_message", (data) => {
      if (data.conversationId === conversationId) {
        chat(`[${data.senderId}] ${data.content}`);
      }
    });
  
    socket.on("new_notification", (data) => {
      log(`ðŸ”” Notification from ${data.from}: ${data.text}`);
    });
  
    socket.on("message_sent", () => {
      log("ðŸ“¨ Message stored in DB");
    });
  }
  
  function joinPrivate() {
    const userId = document.getElementById("userId").value;
    socket.emit("userId", userId);
    log(`ðŸ“¥ Listening for notifications on: user_${userId}`);
  }
  
  function openChat() {
    const senderId = document.getElementById("userId").value;
    const receiverId = document.getElementById("receiverId").value;
  
    if(!senderId || !receiverId) {
      alert("Please enter both IDs");
      return;
    }
  
    socket.emit("open_chat", { senderId, receiverId });
    log(`ðŸ’¬ Requesting chat with user ${receiverId}...`);
  }
  
  function sendMessage() {
    const senderId = document.getElementById("userId").value;
    const receiverId = document.getElementById("receiverId").value;
    const content = document.getElementById("message").value;
  
    if (!conversationId) {
      alert("Open chat first");
      return;
    }
  
    socket.emit("send_message", {
      conversationId,
      senderId,
      receiverId,
      content
    });
  
    document.getElementById("message").value = "";
  }
  </script>

</body>
</html>
